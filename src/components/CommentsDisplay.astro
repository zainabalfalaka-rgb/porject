---
export interface Props {
  postId: string;
  postType: 'warning' | 'lawyer' | 'guide' | 'case';
}

const { postId, postType } = Astro.props;
---

<section class="comments-display-section">
  <div class="comments-container">
    <div class="comments-header">
      <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
      <div class="comments-count">
        <span id="commentsCount">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>
    </div>
    
    <div class="comments-list" id="commentsList" data-post-id={postId}>
      <div class="loading-comments">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p>
      </div>
    </div>
    
    <div class="no-comments" id="noComments" style="display: none;">
      <div class="no-comments-icon">ğŸ’¬</div>
      <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</h4>
      <p>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
    </div>
  </div>
</section>

<script>
  import { commentsAPI } from '../lib/supabase.js';
  
  document.addEventListener('DOMContentLoaded', async function() {
    const commentsList = document.getElementById('commentsList');
    const commentsCount = document.getElementById('commentsCount');
    const noComments = document.getElementById('noComments');
    const postId = commentsList?.dataset.postId;
    
    if (!postId) {
      console.error('Post ID not found');
      return;
    }
    
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
      if (!window.supabaseConfigured) {
        commentsList.innerHTML = `
          <div class="supabase-notice">
            <div class="notice-icon">ğŸ”—</div>
            <h4>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</h4>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ù„ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</p>
            <button onclick="alert('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Connect to Supabase ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©')" class="btn btn-primary btn-sm">
              ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙØ¹ÙŠÙ„
            </button>
          </div>
        `;
        return;
      }
      
      // Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
      const comments = await commentsAPI.getApprovedComments(postId);
      const count = comments.length;
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
      if (commentsCount) {
        commentsCount.textContent = count === 0 ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª' : 
                                   count === 1 ? 'ØªØ¹Ù„ÙŠÙ‚ ÙˆØ§Ø­Ø¯' : 
                                   count === 2 ? 'ØªØ¹Ù„ÙŠÙ‚Ø§Ù†' : 
                                   count <= 10 ? `${count} ØªØ¹Ù„ÙŠÙ‚Ø§Øª` : 
                                   `${count} ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹`;
      }
      
      if (comments.length === 0) {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        commentsList.style.display = 'none';
        noComments.style.display = 'block';
      } else {
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        commentsList.innerHTML = comments.map(comment => `
          <article class="comment-item">
            <div class="comment-header">
              <div class="comment-author">
                <div class="author-avatar">
                  ${comment.author_name.charAt(0).toUpperCase()}
                </div>
                <div class="author-info">
                  <h4 class="author-name">${escapeHtml(comment.author_name)}</h4>
                  <time class="comment-date" datetime="${comment.created_at}">
                    ${formatDate(comment.created_at)}
                  </time>
                </div>
              </div>
              <div class="comment-status">
                <span class="approved-badge">âœ“ Ù…Ø¹ØªÙ…Ø¯</span>
              </div>
            </div>
            <div class="comment-content">
              <p>${escapeHtml(comment.comment_text).replace(/\n/g, '<br>')}</p>
            </div>
          </article>
        `).join('');
        
        noComments.style.display = 'none';
      }
      
    } catch (error) {
      console.error('Error loading comments:', error);
      commentsList.innerHTML = `
        <div class="error-loading">
          <div class="error-icon">âš ï¸</div>
          <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.</p>
        </div>
      `;
    }
  });
  
  // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffInHours < 1) {
      return 'Ù…Ù†Ø° Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©';
    } else if (diffInHours < 24) {
      return `Ù…Ù†Ø° ${diffInHours} Ø³Ø§Ø¹Ø©`;
    } else if (diffInHours < 48) {
      return 'Ù…Ù†Ø° ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯';
    } else {
      const diffInDays = Math.floor(diffInHours / 24);
      if (diffInDays <= 30) {
        return `Ù…Ù†Ø° ${diffInDays} Ø£ÙŠØ§Ù…`;
      } else {
        return date.toLocaleDateString('ar-AE', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
    }
  }
  
  // Ø¯Ø§Ù„Ø© Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Øµ Ù…Ù† XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

<style>
  .comments-display-section {
    background: white;
    padding: var(--space-8) 0;
  }

  .comments-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 var(--space-4);
  }

  .comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--color-neutral-200);
  }

  .comments-header h3 {
    font-size: 1.75rem;
    color: var(--color-neutral-900);
    margin: 0;
  }

  .comments-count {
    background: var(--color-primary);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: 0.875rem;
    font-weight: var(--font-weight-semibold);
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .loading-comments {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-8);
    color: var(--color-neutral-500);
  }

  .loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid var(--color-neutral-200);
    border-top: 3px solid var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .comment-item {
    background: var(--color-neutral-50);
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--color-primary);
    transition: all 0.3s ease;
  }

  .comment-item:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .comment-author {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .author-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-weight-bold);
    font-size: 1.125rem;
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .author-name {
    font-size: 1rem;
    font-weight: var(--font-weight-semibold);
    color: var(--color-neutral-900);
    margin: 0;
  }

  .comment-date {
    font-size: 0.875rem;
    color: var(--color-neutral-500);
  }

  .comment-status {
    display: flex;
    align-items: center;
  }

  .approved-badge {
    background: var(--color-success);
    color: white;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    font-weight: var(--font-weight-bold);
  }

  .comment-content {
    margin-top: var(--space-4);
  }

  .comment-content p {
    color: var(--color-neutral-700);
    line-height: var(--line-height-relaxed);
    margin: 0;
    font-size: 1rem;
  }

  .no-comments {
    text-align: center;
    padding: var(--space-12);
    color: var(--color-neutral-500);
  }

  .no-comments-icon {
    font-size: 3rem;
    margin-bottom: var(--space-4);
    opacity: 0.5;
  }

  .no-comments h4 {
    font-size: 1.25rem;
    margin-bottom: var(--space-2);
    color: var(--color-neutral-600);
  }

  .no-comments p {
    margin: 0;
    font-size: 1rem;
  }

  .error-loading {
    text-align: center;
    padding: var(--space-8);
    background: rgba(239, 68, 68, 0.1);
    border-radius: var(--radius-lg);
    border: 2px solid rgba(239, 68, 68, 0.2);
  }

  .error-icon {
    font-size: 2rem;
    margin-bottom: var(--space-4);
  }

  .error-loading p {
    color: var(--color-error);
    margin: 0;
    font-weight: var(--font-weight-semibold);
  }

  .supabase-notice {
    text-align: center;
    padding: var(--space-8);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: white;
    border-radius: var(--radius-lg);
  }

  .notice-icon {
    font-size: 2rem;
    margin-bottom: var(--space-4);
  }

  .supabase-notice h4 {
    font-size: 1.25rem;
    margin-bottom: var(--space-2);
    color: white;
  }

  .supabase-notice p {
    margin-bottom: var(--space-4);
    color: rgba(255, 255, 255, 0.9);
  }

  .btn-sm {
    padding: var(--space-2) var(--space-4);
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .comments-header {
      flex-direction: column;
      gap: var(--space-3);
      align-items: flex-start;
    }

    .comment-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .comment-status {
      align-self: flex-end;
    }

    .author-avatar {
      width: 35px;
      height: 35px;
      font-size: 1rem;
    }
  }
</style>